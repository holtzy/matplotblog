<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>GSoC'21: Pre-Quarter Progress &#183; Matplotblog</title><meta name=description content="Pre-Quarter Progress with Google Summer of Code 2021 project under NumFOCUS: Aitik Gupta"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link href=https://matplotlib.org/matplotblog/css/concated.min.css rel=stylesheet><style>body{background:#ecedef url(https://matplotlib.org/matplotblog/bg_tiles.png)repeat}</style></head><body class=single-body><nav class="nav-bar side-padding"><h1 class=nav-header><a href=https://matplotlib.org/matplotblog/ class=nav-text><img src=https://matplotlib.org/matplotblog/mpl_logo.png></a></h1><a href=https://matplotlib.org/matplotblog/index.xml><img src=https://matplotlib.org/matplotblog/rss.svg style=width:25px;margin:10px alt="RSS feed"></a><div class=hamburger-menu><button onclick=hamburgerMenuPressed.call(this) aria-haspopup=true aria-expanded=false aria-controls=menu aria-label=Menu>
<span></span><span></span></button><ul id=menu class=hamburger-menu-overlay><li><a href=https://matplotlib.org/matplotblog/ class=hamburger-menu-overlay-link>Home</a></li><li><a href=https://matplotlib.org/matplotblog/posts/how-to-contribute/ class=hamburger-menu-overlay-link>How to Contribute</a></li><li><a href=https://matplotlib.org/matplotblog/categories/3d class=hamburger-menu-overlay-link>3d</a></li><li><a href=https://matplotlib.org/matplotblog/categories/academia class=hamburger-menu-overlay-link>Academia</a></li><li><a href=https://matplotlib.org/matplotblog/categories/art class=hamburger-menu-overlay-link>Art</a></li><li><a href=https://matplotlib.org/matplotblog/categories/editorial class=hamburger-menu-overlay-link>Editorial</a></li><li><a href=https://matplotlib.org/matplotblog/categories/graphs class=hamburger-menu-overlay-link>Graphs</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsoc class=hamburger-menu-overlay-link>Gsoc</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsod class=hamburger-menu-overlay-link>Gsod</a></li><li><a href=https://matplotlib.org/matplotblog/categories/industry class=hamburger-menu-overlay-link>Industry</a></li><li><a href=https://matplotlib.org/matplotblog/categories/news class=hamburger-menu-overlay-link>News</a></li><li><a href=https://matplotlib.org/matplotblog/categories/tutorials class=hamburger-menu-overlay-link>Tutorials</a></li><li><a href=https://matplotlib.org class=hamburger-menu-overlay-link target=blank>About</a></li></ul></div></nav><main class="content side-text-padding"><article class="post dropcase"><header class=post-header><h1 class=post-title>GSoC'21: Pre-Quarter Progress</h1><p class=post-date>Posted <time datetime=2021-07-19>Jul 19, 2021</time>
<span class=post-author>&mdash; By Aitik Gupta</span></p></header><picture class=post-figure>
<source srcset=https://matplotlib.org/matplotblog/posts/gsoc_2021_prequarter/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png><img src=https://matplotlib.org/matplotblog/posts/gsoc_2021_prequarter/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png></picture><p><strong>‚Äú<ins>Well? Did you get it working?!</ins>‚Äù</strong></p><p>Before I answer that question, if you're missing the context, check out my <a href=https://matplotlib.org/matplotblog/posts/gsoc_2021_midterm/>previous blog</a>&lsquo;s last few lines.. promise it won't take you more than 30 seconds to get the whole problem!</p><p>With this short writeup, I intend to talk about <em>what</em> we did and <em>why</em> we did, what we did. XD</p><h2 id=ostrich-algorithm>Ostrich Algorithm</h2><p>Ring any bells? Remember OS (Operating Systems)? It's one of the core CS subjects which I bunked then and regret now. (‚ï•Ôπè‚ï•)</p><p>The <a href=https://en.wikipedia.org/wiki/Ostrich_algorithm>wikipedia page</a> has a 2-liner explaination if you have no idea what's an Ostrich Algorithm.. but I know most of y'all won't bother clicking it XD, so here goes:</p><blockquote><p>Ostrich algorithm is a strategy of ignoring potential problems by &ldquo;sticking one's head in the sand and pretending there is no problem&rdquo;</p></blockquote><p>An important thing to note: it is used when it is more <strong>cost-effective</strong> to <em>allow the problem to occur than to attempt its prevention</em>.</p><p>As you might've guessed by now, we ultimately ended up with the <em>not-so-clean</em> API (more on this later).</p><h2 id=what-was-the-problem>What was the problem?</h2><p>The highest level overview of the problem was:</p><pre><code>‚ùå fontTools -&gt; buffer -&gt; ttconv_with_buffer
‚úÖ fontTools -&gt; buffer -&gt; tempfile -&gt; ttconv_with_file
</code></pre><p>The first approach created corrupted outputs, however the second approach worked fine. A point to note here would be that <em>Method 1</em> is better in terms of separation of <em>reading</em> the file from <em>parsing</em> the data.</p><ol><li><a href=https://github.com/fonttools/fonttools>fontTools</a> handles the Type42 subsetting for us, whereas <a href=https://github.com/matplotlib/matplotlib/tree/master/extern/ttconv>ttconv</a> handles the embedding.</li><li><code>ttconv_with_buffer</code> is a modification to the original <code>ttconv_with_file</code>; that allows it to input a file buffer instead of a file-path</li></ol><p>You might be tempted to say:</p><blockquote><p>&ldquo;Well, <code>ttconv_with_buffer</code> must be wrongly modified, duh.&rdquo;</p></blockquote><p>Logically, yes. <code>ttconv</code> was designed to work with a file-path and not a file-object (buffer), and modifying a codebase <strong>written in 1998</strong> turned out to be a larger pain than we anticipated.</p><h4 id=it-came-to-a-point-where-one-of-my-mentors-decided-to-implement-everything-in-python>It came to a point where one of my mentors decided to implement everything in Python!</h4><p>He even did, but <ins>the efforts</ins> to get it to production / or to fix <code>ttconv</code> embedding were ‚ãô to just get on with the second method. That damn ostrich really helped us get out of that debugging hell. üôÉ</p><h2 id=font-fallback---initial-steps>Font Fallback - initial steps</h2><p>Finally, we're onto the second subgoal for the summer: <a href=https://www.w3schools.com/css/css_font_fallbacks.asp>Font Fallback</a>!</p><p>To give an idea about how things work right now:</p><ol><li>User asks Matplotlib to use certain font families, specified by:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>matplotlib<span style=color:#f92672>.</span>rcParams[<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>font-family</span><span style=color:#e6db74>&#34;</span>] <span style=color:#f92672>=</span> [<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>list</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>of</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>font</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>families</span><span style=color:#e6db74>&#34;</span>]
</code></pre></div><ol start=2><li>This list is used to search for available fonts on a user's system.</li><li>However, in current (and previous) versions of Matplotlib:</li></ol><blockquote><p><ins>As soon as a font is found by iterating the font-family, <strong>all text</strong> is rendered by that <em>and only that</em> font.</ins></p></blockquote><p>You can immediately see the problems with this approach; using the same font for every character will not render any glyph which isn't present in that font, and will instead spit out a square rectangle called &ldquo;tofu&rdquo; (read the first line <a href=https://www.google.com/get/noto/>here</a>).</p><p>And that is exactly the first milestone! That is, parsing the <em><ins>entire list</ins></em> of font families to get an intermediate representation of a multi-font interface.</p><h2 id=dont-break-a-lot-at-stake>Don't break, a lot at stake!</h2><p>Imagine if you had the superpower to change Python standard library's internal functions, <em>without</em> consulting anybody. Let's say you wanted to write a solution by hooking in and changing, let's say <code>str("dumb")</code> implementation by returning:</p><pre><code class=language-ipython data-lang=ipython>&gt;&gt;&gt; str(&quot;dumb&quot;)
[&quot;d&quot;, &quot;u&quot;, &quot;m&quot;, &quot;b&quot;]
</code></pre><p>Pretty &ldquo;<ins>dumb</ins>&rdquo;, right? xD</p><p>For your usecase it might work fine, but it would also mean breaking the <em>entire</em> Python userbase&rsquo; workflow, not to mention the 1000000+ libraries that depend on the original functionality.</p><p>On a similar note, Matplotlib has a public API known as <code>findfont(prop: str)</code>, which when given a string (or <a href=https://matplotlib.org/stable/api/font_manager_api.html#matplotlib.font_manager.FontProperties>FontProperties</a>) finds you a font that best matches the given properties in your system.</p><p>It is used <ins>throughout the library</ins>, as well as at multiple other places, including downstream libraries. Being naive as I was, I changed this function signature and submitted the <a href=https://github.com/matplotlib/matplotlib/pull/20496>PR</a>. ü•≤</p><p>Had an insightful discussion about this with my mentors, and soon enough raised the <a href=https://github.com/matplotlib/matplotlib/pull/20549>other PR</a>, which didn't touch the <code>findfont</code> API at all.</p><hr><p>One last thing to note: Even if we do complete the first milestone, we wouldn't be done yet, since this is just parsing the entire list to get multiple fonts..</p><p>We still need to migrate the library's internal implementation from <strong>font-first</strong> to <strong>text-first</strong>!</p><p>But that's for later, for now:
<img src=https://user-images.githubusercontent.com/43996118/126441988-5a2067fd-055e-44e5-86e9-4dddf47abc9d.png alt=OnceAgainThankingYou></p><h4 id=note-this-blog-post-is-also-available-at-my-personal-websitehttpsaitikguptagithubiogsoc-pre-quarter>NOTE: This blog post is also available at my <a href=https://aitikgupta.github.io/gsoc-pre-quarter/>personal website</a>.</h4></article></main><nav class="end-nav side-padding"></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous onload=renderMathInElement(document.body);></script><script src=https://matplotlib.org/matplotblog/js/core.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>