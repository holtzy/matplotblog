<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>GSoC'21: Mid-Term Progress &#183; Matplotblog</title><meta name=description content="Mid-Term Progress with Google Summer of Code 2021 project under NumFOCUS: Aitik Gupta"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link href=https://matplotlib.org/matplotblog/css/concated.min.css rel=stylesheet><style>body{background:#ecedef url(https://matplotlib.org/matplotblog/bg_tiles.png)repeat}</style></head><body class=single-body><nav class="nav-bar side-padding"><h1 class=nav-header><a href=https://matplotlib.org/matplotblog/ class=nav-text><img src=https://matplotlib.org/matplotblog/mpl_logo.png></a></h1><a href=https://matplotlib.org/matplotblog/index.xml><img src=https://matplotlib.org/matplotblog/rss.svg style=width:25px;margin:10px alt="RSS feed"></a><div class=hamburger-menu><button onclick=hamburgerMenuPressed.call(this) aria-haspopup=true aria-expanded=false aria-controls=menu aria-label=Menu>
<span></span><span></span></button><ul id=menu class=hamburger-menu-overlay><li><a href=https://matplotlib.org/matplotblog/ class=hamburger-menu-overlay-link>Home</a></li><li><a href=https://matplotlib.org/matplotblog/posts/how-to-contribute/ class=hamburger-menu-overlay-link>How to Contribute</a></li><li><a href=https://matplotlib.org/matplotblog/categories/3d class=hamburger-menu-overlay-link>3d</a></li><li><a href=https://matplotlib.org/matplotblog/categories/academia class=hamburger-menu-overlay-link>Academia</a></li><li><a href=https://matplotlib.org/matplotblog/categories/art class=hamburger-menu-overlay-link>Art</a></li><li><a href=https://matplotlib.org/matplotblog/categories/editorial class=hamburger-menu-overlay-link>Editorial</a></li><li><a href=https://matplotlib.org/matplotblog/categories/graphs class=hamburger-menu-overlay-link>Graphs</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsoc class=hamburger-menu-overlay-link>Gsoc</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsod class=hamburger-menu-overlay-link>Gsod</a></li><li><a href=https://matplotlib.org/matplotblog/categories/industry class=hamburger-menu-overlay-link>Industry</a></li><li><a href=https://matplotlib.org/matplotblog/categories/news class=hamburger-menu-overlay-link>News</a></li><li><a href=https://matplotlib.org/matplotblog/categories/tutorials class=hamburger-menu-overlay-link>Tutorials</a></li><li><a href=https://matplotlib.org class=hamburger-menu-overlay-link target=blank>About</a></li></ul></div></nav><main class="content side-text-padding"><article class="post dropcase"><header class=post-header><h1 class=post-title>GSoC'21: Mid-Term Progress</h1><p class=post-date>Posted <time datetime=2021-07-02>Jul 2, 2021</time>
<span class=post-author>&mdash; By Aitik Gupta</span></p></header><picture class=post-figure>
<source srcset=https://matplotlib.org/matplotblog/posts/gsoc_2021_midterm/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png><img src=https://matplotlib.org/matplotblog/posts/gsoc_2021_midterm/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png></picture><p><strong>&ldquo;<ins>Aitik, how is your GSoC going?</ins>&rdquo;</strong></p><p>Well, it's been a while since I last wrote. But I wasn't spending time watching <em>Loki</em> either! (that's a lie.)</p><p>During this period the project took on some interesting (and stressful) curves, which I intend to talk about in this small writeup.</p><h2 id=new-mentor>New Mentor!</h2><p>The first week of coding period, and I met one of my new mentors, <a href=https://github.com/jkseppan>Jouni</a>. Without him, along with <a href=https://github.com/tacaswell>Tom</a> and <a href=https://github.com/anntzer>Antony</a>, the project wouldn't have moved <em>an inch</em>.</p><p>It was initially Jouni's <a href=https://github.com/matplotlib/matplotlib/pull/18143>PR</a> which was my starting point of the first milestone in my proposal, <ins>Font Subsetting</ins>.</p><h2 id=what-is-font-subsetting-anyway>What is Font Subsetting anyway?</h2><p>As was proposed by Tom, a good way to understand something is to document your journey along the way! (well, that's what GSoC wants us to follow anyway right?)</p><p>Taking an excerpt from one of the paragraphs I wrote <a href=https://github.com/matplotlib/matplotlib/blob/a94f52121cea4194a5d6f6fc94eafdfb03394628/doc/users/fonts.rst#subsetting>here</a>:</p><blockquote><p>Font Subsetting can be used before generating documents, to embed only the <em>required</em> glyphs within the documents. Fonts can be considered as a collection of these glyphs, so ultimately the goal of subsetting is to find out which glyphs are required for a certain array of characters, and embed only those within the output.</p></blockquote><p>Now this may seem straightforward, right?</p><h4 id=wrong>Wrong.</h4><p>The glyph programs can call their own subprograms, for example, characters like <code>√§</code> could be composed by calling subprograms for <code>a</code> and <code>¬®</code>; or <code>‚Üí</code> could be composed by a program that changes the display matrix and calls the subprogram for <code>‚Üê</code>.</p><p>Since the subsetter has to find out <em>all such subprograms</em> being called by <em>every glyph</em> included in the subset, this is a generally difficult problem!</p><p>Something which one of my mentors said which <em>really</em> stuck with me:</p><blockquote><p>Matplotlib isn't a font library, and shouldn't try to be one.</p></blockquote><p>It's really easy to fall into the trap of trying to do <em>everything</em> within your own project, which ends up rather <em>hurting</em> itself.</p><p>Since this holds true even for Matplotlib, it uses external dependencies like <a href=https://www.freetype.org/>FreeType</a>, <a href=https://github.com/sandflow/ttconv>ttconv</a>, and newly proposed <a href=https://github.com/fonttools/fonttools>fontTools</a> to handle font subsetting, embedding, rendering, and related stuff.</p><p>PS: If that font stuff didn't make sense, I would recommend going through a friendly tutorial I wrote, which is all about <a href=https://matplotlib.org/stable/users/fonts.html>Matplotlib and Fonts</a>!</p><h2 id=unexpected-complications>Unexpected Complications</h2><p>Matplotlib uses an external dependency <code>ttconv</code> which was initially forked into Matplotlib's repository <strong>in 2003</strong>!</p><blockquote><p>ttconv was a standalone commandline utility for converting TrueType fonts to subsetted Type 3 fonts (among other features) written in 1995, which Matplotlib forked in order to make it work as a library.</p></blockquote><p>Over the time, there were a lot of issues with it which were either hard to fix, or didn't attract a lot of attention. (See the above paragraph for a valid reason)</p><p>One major utility which is still used is <code>convert_ttf_to_ps</code>, which takes a <em>font path</em> as input and converts it into a Type 3 or Type 42 PostScript font, which can be embedded within PS/EPS output documents. The guide I wrote (<a href=https://matplotlib.org/stable/users/fonts.html>link</a>) contains decent descriptions, the differences between these type of fonts, etc.</p><h4 id=so-we-need-to-convert-that-_font-path_-input-to-a-_font-buffer_-input>So we need to convert that <em>font path</em> input to a <em>font buffer</em> input.</h4><p>Why do we need to? Type 42 subsetting isn't really supported by ttconv, so we use a new dependency called fontTools, whose &lsquo;full-time job&rsquo; is to subset Type 42 fonts for us (among other things).</p><blockquote><p>It provides us with a font buffer, however ttconv expects a font path to embed that font</p></blockquote><p>Easily enough, this can be done by Python's <code>tempfile.NamedTemporaryFile</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>.ttf</span><span style=color:#e6db74>&#34;</span>) <span style=color:#66d9ef>as</span> tmp:
	<span style=color:#75715e># fontdata is the subsetted buffer</span>
	<span style=color:#75715e># returned from fontTools</span>
	tmp<span style=color:#f92672>.</span>write(fontdata<span style=color:#f92672>.</span>getvalue())

	<span style=color:#75715e># TODO: allow convert_ttf_to_ps</span>
	<span style=color:#75715e># to input file objects (BytesIO)</span>
	convert_ttf_to_ps(
		os<span style=color:#f92672>.</span>fsencode(tmp<span style=color:#f92672>.</span>name),
		fh,
		fonttype,
		glyph_ids,
	)
</code></pre></div><p><em><strong>But this is far from a clean API; in terms of separation of *reading* the file from *parsing* the data.</strong></em></p><p>What we <em>ideally</em> want is to pass the buffer down to <code>convert_ttf_to_ps</code>, and modify the embedding code of <code>ttconv</code> (written in C++). And <em>here</em> we come across a lot of unexplored codebase, <em>which wasn't touched a lot ever since it was forked</em>.</p><p>Funnily enough, just yesterday, after spending a lot of quality time, me and my mentors figured out that the <strong>whole logging system of ttconv was broken</strong>, all because of a single debugging function. ü•≤</p><hr><p>This is still an ongoing problem that we need to tackle over the coming weeks, hopefully by the next time I write one of these blogs, it gets resolved!</p><p>Again, thanks a ton for spending time reading these blogs. :D</p><h4 id=note-this-blog-post-is-also-available-at-my-personal-websitehttpsaitikguptagithubiogsoc-mid>NOTE: This blog post is also available at my <a href=https://aitikgupta.github.io/gsoc-mid/>personal website</a>.</h4></article></main><nav class="end-nav side-padding"></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous onload=renderMathInElement(document.body);></script><script src=https://matplotlib.org/matplotblog/js/core.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>